<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Хватит дрочить - стань воином</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --text-primary: #212529;
            --text-secondary: #495057;
            --accent: #4361ee;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #f8961e;
            --border-radius: 12px;
            --box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .dark-theme {
            --bg-primary: #121212;
            --bg-secondary: #1e1e1e;
            --text-primary: #f8f9fa;
            --text-secondary: #adb5bd;
            --accent: #4895ef;
            --box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.25), 0 2px 4px -1px rgba(0, 0, 0, 0.15);
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: var(--transition);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .card {
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .dark-theme .card {
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .btn {
            border-radius: 8px;
            font-weight: 600;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background-color: #3a56e8;
            transform: translateY(-1px);
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .input-field {
            border-radius: 8px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            transition: var(--transition);
            background-color: var(--bg-secondary);
            color: var(--text-primary);
        }

        .input-field:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        .progress-bar {
            height: 8px;
            border-radius: 4px;
            background-color: rgba(67, 97, 238, 0.1);
        }

        .progress-bar-fill {
            height: 100%;
            border-radius: 4px;
            background-color: var(--accent);
            transition: width 0.5s ease;
        }
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body class="dark-theme min-h-screen flex flex-col">
    <!-- Главный экран -->
    <div id="main-screen" class="flex flex-col items-center justify-center flex-grow p-4">
        <div class="card p-8 max-w-2xl w-full text-center shadow-2xl">
            <h1 class="text-4xl md:text-5xl font-bold mb-8 text-accent">ХВАТИТ ДРОЧИТЬ - СТАНЬ ВОИНОМ</h1>
            <div class="flex space-x-4 justify-center mb-8">
            <button id="login-btn" class="btn btn-primary px-6 py-3">
                <i class="fas fa-sign-in-alt"></i> Войти
            </button>
            <button id="register-btn" class="btn px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-800 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-white">
                <i class="fas fa-user-plus"></i> Регистрация
            </button>
        </div>
            </div>
            <div class="text-sm text-gray-500 dark:text-gray-400 mb-4">
                Пройди 31-дневный челлендж и измени свою жизнь
            </div>
        </div>
        <div class="absolute bottom-4 right-4">
            <button id="dev-btn" class="p-2 bg-gray-800 text-white rounded-full shadow-lg">
                <i class="fas fa-code"></i>
            </button>
        </div>
    </div>

    <!-- Форма входа -->
    <div id="login-form" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="card rounded-lg p-6 w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4">Вход</h2>
            <div class="mb-4">
                <label class="block mb-2">Логин</label>
                <input type="text" id="login-username" class="input-field w-full p-3 bg-white text-black dark:bg-white dark:text-black">
            </div>
            <div class="mb-6">
                <label class="block mb-2">Пароль</label>
                <input type="password" id="login-password" class="w-full p-2 border rounded bg-white text-black dark:bg-white dark:text-black">
            </div>
            <div class="flex justify-between">
                <button id="login-submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded">Войти</button>
                <button id="login-cancel" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded">Отмена</button>
            </div>
        </div>
    </div>

    <!-- Форма регистрации -->
    <div id="register-form" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="card rounded-lg p-6 w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4">Регистрация</h2>
            <div class="mb-4">
                <label class="block mb-2">Логин</label>
                <input type="text" id="register-username" class="w-full p-2 border rounded text-black">
            </div>
            <div class="mb-4">
                <label class="block mb-2">Пароль</label>
                <input type="password" id="register-password" class="w-full p-2 border rounded text-black">
            </div>
            <div class="mb-6">
                <label class="block mb-2">Подтвердите пароль</label>
                <input type="password" id="register-confirm" class="w-full p-2 border rounded text-black">
            </div>
            <div class="flex justify-between">
                <button id="register-submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded">Зарегистрироваться</button>
                <button id="register-cancel" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded">Отмена</button>
            </div>
        </div>
    </div>

    <!-- Вход разработчика -->
    <div id="dev-login" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="card rounded-lg p-6 w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4">Вход разработчика</h2>
            <div class="mb-6">
                <label class="block mb-2">Пароль</label>
                <input type="password" id="dev-password" class="w-full p-2 border rounded text-black">
            </div>
            <div class="flex justify-between">
                <button id="dev-submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded">Войти</button>
                <button id="dev-cancel" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded">Отмена</button>
            </div>
        </div>
    </div>

    <!-- Панель пользователя -->
    <div id="user-panel" class="hidden flex-grow p-4">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h2 id="user-greeting" class="text-2xl font-bold"></h2>
                <div id="user-stats" class="text-lg"></div>
            </div>
            <div class="flex space-x-2">
                <button id="messages-toggle" class="p-2 rounded-full bg-blue-600 hover:bg-blue-700 text-white" title="Общаться с наставником">
                    <i class="fas fa-comments"></i>
                </button>
                <button id="theme-toggle" class="p-2 rounded-full bg-gray-700 hover:bg-gray-600 transition-colors">
                    <i class="fas fa-sun text-yellow-400"></i>
                    <i class="fas fa-moon text-gray-300 hidden"></i>
                </button>
                <button id="logout-btn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded">Выйти</button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Трекер дней -->
            <div class="card rounded-lg p-6">
                <h3 class="text-xl font-bold mb-4">День <span id="current-day">1</span>/31</h3>
                <div id="motivation-text" class="mb-4 text-sm"></div>
                <div class="mb-4">
                    <label class="block mb-2">Энергия сегодня (1-10)</label>
                    <input type="range" id="energy-level" min="1" max="10" value="5" class="w-full">
                    <div class="flex justify-between text-xs">
                        <span>1</span>
                        <span>2</span>
                        <span>3</span>
                        <span>4</span>
                        <span>5</span>
                        <span>6</span>
                        <span>7</span>
                        <span>8</span>
                        <span>9</span>
                        <span>10</span>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block mb-2">Настроение сегодня (1-10)</label>
                    <input type="range" id="mood-level" min="1" max="10" value="5" class="w-full">
                    <div class="flex justify-between text-xs">
                        <span>1</span>
                        <span>2</span>
                        <span>3</span>
                        <span>4</span>
                        <span>5</span>
                        <span>6</span>
                        <span>7</span>
                        <span>8</span>
                        <span>9</span>
                        <span>10</span>
                    </div>
                </div>
                <div class="flex space-x-4 mb-4">
                    <button id="success-btn" class="flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded">
                        <i class="fas fa-check mr-2"></i> Успех
                    </button>
                    <button id="fail-btn" class="flex-1 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded">
                        <i class="fas fa-times mr-2"></i> Сорвался
                    </button>
                </div>
                <div class="mb-4">
                    <label class="block mb-2">Заметки на сегодня</label>
                    <textarea id="daily-notes" class="w-full p-2 border rounded text-black" rows="3"></textarea>
                </div>
                <button id="save-day" class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded">Сохранить день</button>
            </div>

            <!-- Статистика -->
            <div class="card rounded-lg p-6">
                <h3 class="text-xl font-bold mb-4">Ваша статистика</h3>
                <div class="mb-4">
                    <h4 class="font-semibold mb-2">Прогресс</h4>
                    <div class="progress-bar w-full">
                        <div id="progress-bar" class="progress-bar-fill" style="width: 0%"></div>
                    </div>
                    <div id="progress-text" class="text-sm mt-1">0% завершено</div>
                </div>
                <div class="mb-4">
                    <h4 class="font-semibold mb-2">Средняя энергия</h4>
                    <div id="avg-energy" class="text-2xl font-bold">0</div>
                </div>
                <div class="mb-4">
                    <h4 class="font-semibold mb-2">Среднее настроение</h4>
                    <div id="avg-mood" class="text-2xl font-bold">0</div>
                </div>
                <div class="mb-4">
                    <h4 class="font-semibold mb-2">График энергии</h4>
                    <canvas id="energy-chart" class="w-full h-32"></canvas>
                </div>
                <div>
                    <h4 class="font-semibold mb-2">График настроения</h4>
                    <canvas id="mood-chart" class="w-full h-32"></canvas>
                </div>
            </div>

            <!-- Сообщения и история -->
            <div class="card rounded-lg p-6">
                <h3 class="text-xl font-bold mb-4">Сообщения</h3>
                <div id="messages-container" class="mb-4 max-h-48 overflow-y-auto">
                    <!-- Сообщения будут здесь -->
                </div>
                <div class="mb-4">
                    <label class="block mb-2">Новое сообщение</label>
                    <textarea id="new-message" class="w-full p-2 border rounded text-black" rows="2"></textarea>
                </div>
                <button id="send-message" class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded">Отправить</button>
                
                <h3 class="text-xl font-bold mt-6 mb-4">История дней</h3>
                <div id="history-container" class="max-h-48 overflow-y-auto">
                    <!-- История будет здесь -->
                </div>
            </div>
        </div>
    </div>

    <!-- Панель разработчика -->
    <div id="dev-panel" class="hidden flex-grow p-4">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">Панель разработчика</h2>
            <div class="flex space-x-2">
                <button id="inbox-btn" class="p-2 rounded-full bg-blue-600 hover:bg-blue-700 text-white relative" title="Входящие сообщения">
                    <i class="fas fa-inbox"></i>
                    <span id="inbox-badge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
                </button>
                <button id="theme-toggle-dev" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700">
                    <i class="fas fa-moon dark:hidden"></i>
                    <i class="fas fa-sun hidden dark:block"></i>
                </button>
                <button id="dev-logout" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded">Выйти</button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Список пользователей -->
            <div class="card rounded-lg p-6">
                <h3 class="text-xl font-bold mb-4">Пользователи</h3>
                <div class="mb-4">
                    <input type="text" id="user-search" placeholder="Поиск пользователей..." class="w-full p-2 border rounded text-black">
                </div>
                <div id="users-list" class="max-h-96 overflow-y-auto">
                    <!-- Список пользователей будет здесь -->
                </div>
            </div>

            <!-- Данные пользователя -->
            <div class="card rounded-lg p-6">
                <h3 class="text-xl font-bold mb-4">Данные пользователя</h3>
                <div id="selected-user-info" class="mb-4">
                    Выберите пользователя слева
                </div>
                <div id="user-data-container" class="hidden">
                    <div class="mb-4">
                        <h4 class="font-semibold mb-2">Статистика</h4>
                        <div id="dev-user-stats"></div>
                    </div>
                    <div class="mb-4">
                        <h4 class="font-semibold mb-2">История дней</h4>
                        <div id="dev-user-history" class="max-h-48 overflow-y-auto"></div>
                    </div>
                    <div class="mb-4">
                        <h4 class="font-semibold mb-2">Отправить сообщение</h4>
                        <textarea id="dev-message" class="w-full p-2 border rounded text-black" rows="2"></textarea>
                        <button id="dev-send-message" class="mt-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded">Отправить</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Messages Modal -->
    <div id="user-messages-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="card rounded-lg p-6 w-full max-w-md max-h-[80vh] overflow-hidden">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Общение с наставником</h3>
                <button id="close-user-messages" class="p-2 text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="user-messages-container" class="overflow-y-auto max-h-[60vh] pr-2 mb-4">
                <!-- Messages will be loaded here -->
            </div>
            <div class="flex space-x-2">
                <textarea id="user-message-input" class="flex-1 p-2 border rounded text-black" rows="2" placeholder="Ваше сообщение..."></textarea>
                <button id="send-user-message" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Inbox Modal -->
    <div id="inbox-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="card rounded-lg p-6 w-full max-w-2xl max-h-[80vh] overflow-hidden">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Входящие сообщения</h3>
                <button id="close-inbox" class="p-2 text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="inbox-messages" class="overflow-y-auto max-h-[60vh] pr-2">
                <!-- Messages will be loaded here -->
            </div>
            <div class="mt-4">
                <textarea id="inbox-reply" class="w-full p-2 border rounded text-black" rows="3" placeholder="Ответ пользователю..."></textarea>
                <button id="send-reply" class="mt-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded">Отправить ответ</button>
            </div>
        </div>
    </div>

    <!-- Inbox Modal -->
    <div id="inbox-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="card rounded-lg p-6 w-full max-w-2xl max-h-[80vh] overflow-hidden">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Входящие сообщения</h3>
                <button id="close-inbox" class="p-2 text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="inbox-messages" class="overflow-y-auto max-h-[60vh] pr-2">
                <!-- Messages will be loaded here -->
            </div>
            <div class="mt-4">
                <textarea id="inbox-reply" class="w-full p-2 border rounded text-black" rows="3" placeholder="Ответ пользователю..."></textarea>
                <button id="send-reply" class="mt-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded">Отправить ответ</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Локальное хранилище для пользователей и разработчика
        const usersDB = JSON.parse(localStorage.getItem('usersDB')) || {};
        const devDB = JSON.parse(localStorage.getItem('devDB')) || { inbox: [] };
        const DEV_PASSWORD = "78";
        
        // Текущий пользователь
        let currentUser = null;
        let currentDay = 1;
        let isDevMode = false;
        
        // Мотивационные тексты для каждого дня
        const motivationTexts = [
            "Первый день - самый сложный. Помни, что каждый великий путь начинается с первого шага.",
            "Твой мозг уже начинает восстанавливаться. Продолжай в том же духе!",
            "После 3 дней воздержания уровень тестостерона начинает расти.",
            "Через 4 дня уменьшается тревожность и улучшается сон.",
            "5 дней без порно - и твоя концентрация уже заметно улучшилась.",
            "Неделя без мастурбации - ты уже чувствуешь прилив энергии?",
            "7 дней - отличный результат! Твой дофаминовый баланс восстанавливается.",
            "После 8 дней улучшается качество эрекции и либидо.",
            "9 дней - твоя уверенность в себе растет с каждым днем.",
            "Десятый день! Ты уже на трети пути к 30-дневному челленджу.",
            "11 дней - твой мозг продолжает перестраиваться на здоровые источники удовольствия.",
            "Две недели без порно - ты замечаешь, как изменилось твое восприятие женщин?",
            "15 дней - критический момент. Не сдавайся сейчас!",
            "После 16 дней воздержания многие отмечают повышение творческих способностей.",
            "17 дней - твоя сила воли становится сильнее с каждым днем.",
            "18 дней - ты уже преодолел больше половины пути!",
            "19 дней - твоя энергия продолжает расти. Используй ее продуктивно!",
            "20 дней - ты уже близок к финишу. Не останавливайся!",
            "21 день - столько времени нужно, чтобы сформировать новую привычку.",
            "22 дня - твой мозг почти полностью перестроился.",
            "23 дня - ты уже чувствуешь себя другим человеком?",
            "24 дня - осталось совсем немного до полного месяца!",
            "25 дней - твоя дисциплина впечатляет. Так держать!",
            "26 дней - ты уже почти у цели. Не сдавайся сейчас!",
            "27 дней - последний рывок! Ты сможешь!",
            "28 дней - всего 3 дня осталось до полного месяца!",
            "29 дней - ты почти у цели. Гордись собой!",
            "30 дней - это огромное достижение! Ты доказал себе, что можешь все!",
            "31 день - полный месяц без порно и мастурбации. Ты настоящий воин!"
        ];

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            // Устанавливаем темную тему по умолчанию
            localStorage.setItem('theme', 'dark');

            // Инициализация кнопок
            initButtons();
            
            // Проверяем, есть ли активный пользователь
            const activeUser = localStorage.getItem('activeUser');
            if (activeUser) {
                currentUser = activeUser;
                loadUserPanel();
            }
            
            // Проверяем, есть ли активный разработчик
            const activeDev = localStorage.getItem('activeDev');
            if (activeDev === 'true') {
                isDevMode = true;
                loadDevPanel();
            }
        });

        // Инициализация всех кнопок и событий
        function initButtons() {
            // User messages buttons
            document.getElementById('messages-toggle')?.addEventListener('click', showUserMessages);
            document.getElementById('close-user-messages')?.addEventListener('click', hideUserMessages);
            document.getElementById('send-user-message')?.addEventListener('click', sendUserMessage);
            
            // Inbox buttons
            document.getElementById('inbox-btn')?.addEventListener('click', showInbox);
            document.getElementById('close-inbox')?.addEventListener('click', hideInbox);
            document.getElementById('send-reply')?.addEventListener('click', sendReply);
            // Главный экран
            document.getElementById('login-btn').addEventListener('click', showLoginForm);
            document.getElementById('register-btn').addEventListener('click', showRegisterForm);
            document.getElementById('dev-btn').addEventListener('click', showDevLogin);
            
            // Форма входа
            document.getElementById('login-submit').addEventListener('click', loginUser);
            document.getElementById('login-cancel').addEventListener('click', hideLoginForm);
            
            // Форма регистрации
            document.getElementById('register-submit').addEventListener('click', registerUser);
            document.getElementById('register-cancel').addEventListener('click', hideRegisterForm);
            
            // Вход разработчика
            document.getElementById('dev-submit').addEventListener('click', loginDev);
            document.getElementById('dev-cancel').addEventListener('click', hideDevLogin);
            
            // Панель пользователя
            document.getElementById('logout-btn').addEventListener('click', logoutUser);
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
            document.getElementById('success-btn').addEventListener('click', markDayAsSuccess);
            document.getElementById('fail-btn').addEventListener('click', markDayAsFail);
            document.getElementById('save-day').addEventListener('click', saveDay);
            document.getElementById('send-message').addEventListener('click', sendUserMessage);
            
            // Панель разработчика
            document.getElementById('dev-logout').addEventListener('click', logoutDev);
            document.getElementById('theme-toggle-dev').addEventListener('click', toggleTheme);
            document.getElementById('user-search').addEventListener('input', searchUsers);
            document.getElementById('dev-send-message').addEventListener('click', sendDevMessage);
        }

        // Показать/скрыть формы
        function showLoginForm() {
            document.getElementById('login-form').classList.remove('hidden');
        }

        function hideLoginForm() {
            document.getElementById('login-form').classList.add('hidden');
        }

        function showRegisterForm() {
            document.getElementById('register-form').classList.remove('hidden');
        }

        function hideRegisterForm() {
            document.getElementById('register-form').classList.add('hidden');
        }

        function showDevLogin() {
            document.getElementById('dev-login').classList.remove('hidden');
        }

        function hideDevLogin() {
            document.getElementById('dev-login').classList.add('hidden');
        }

        // Вход пользователя
        function loginUser() {
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value.trim();
            
            if (!username || !password) {
                alert('Пожалуйста, заполните все поля');
                return;
            }
            
            if (!usersDB[username]) {
                alert('Пользователь не найден');
                return;
            }
            
            if (usersDB[username].password !== password) {
                alert('Неверный пароль');
                return;
            }
            
            currentUser = username;
            localStorage.setItem('activeUser', username);
            hideLoginForm();
            loadUserPanel();
        }

        // Регистрация пользователя
        function registerUser() {
            const username = document.getElementById('register-username').value.trim();
            const password = document.getElementById('register-password').value.trim();
            const confirm = document.getElementById('register-confirm').value.trim();
            
            if (!username || !password || !confirm) {
                alert('Пожалуйста, заполните все поля');
                return;
            }
            
            if (password !== confirm) {
                alert('Пароли не совпадают');
                return;
            }
            
            if (usersDB[username]) {
                alert('Пользователь с таким именем уже существует');
                return;
            }
            
            // Создаем нового пользователя
            usersDB[username] = {
                password: password,
                stats: {
                    successDays: 0,
                    failDays: 0,
                    currentStreak: 0,
                    longestStreak: 0
                },
                days: {},
                messages: [],
                energyHistory: [],
                moodHistory: [],
                registrationDate: new Date().toISOString(),
                lastActivity: new Date().toISOString()
            };
            
            // Сохраняем в локальное хранилище
            localStorage.setItem('usersDB', JSON.stringify(usersDB));
            
            alert('Регистрация успешна! Теперь вы можете войти.');
            hideRegisterForm();
        }

        // Вход разработчика
        function loginDev() {
            const password = document.getElementById('dev-password').value.trim();
            
            if (password !== DEV_PASSWORD) {
                alert('Неверный пароль разработчика');
                return;
            }
            
            isDevMode = true;
            localStorage.setItem('activeDev', 'true');
            hideDevLogin();
            loadDevPanel();
        }

        // Выход пользователя
        function logoutUser() {
            currentUser = null;
            localStorage.removeItem('activeUser');
            document.getElementById('user-panel').classList.add('hidden');
            document.getElementById('main-screen').classList.remove('hidden');
        }

        // Выход разработчика
        function logoutDev() {
            isDevMode = false;
            localStorage.removeItem('activeDev');
            document.getElementById('dev-panel').classList.add('hidden');
            document.getElementById('main-screen').classList.remove('hidden');
        }

        // Загрузка панели пользователя
        function loadUserPanel() {
            document.getElementById('main-screen').classList.add('hidden');
            document.getElementById('user-panel').classList.remove('hidden');
            
            const user = usersDB[currentUser];
            
            // Приветствие и статистика
            document.getElementById('user-greeting').textContent = `Привет, ${currentUser}!`;
            document.getElementById('user-stats').innerHTML = `
                Успешных дней: <span class="text-green-500">${user.stats.successDays}</span> |
                Срывов: <span class="text-red-500">${user.stats.failDays}</span> |
                Текущий день: <span class="text-blue-500">${user.stats.currentStreak}</span>
            `;
            
            // Определяем текущий день
            const lastDay = Math.max(...Object.keys(user.days).map(Number).filter(Number.isInteger), 0);
            currentDay = lastDay < 31 ? lastDay + 1 : 31;
            
            // Если день уже был начат, загружаем данные
            if (user.days[currentDay]) {
                document.getElementById('energy-level').value = user.days[currentDay].energy || 5;
                document.getElementById('mood-level').value = user.days[currentDay].mood || 5;
                document.getElementById('daily-notes').value = user.days[currentDay].notes || '';
                
                if (user.days[currentDay].status === 'success') {
                    document.getElementById('success-btn').classList.add('bg-green-700');
                } else if (user.days[currentDay].status === 'fail') {
                    document.getElementById('fail-btn').classList.add('bg-red-700');
                }
            }
            
            document.getElementById('current-day').textContent = currentDay;
            document.getElementById('motivation-text').textContent = motivationTexts[currentDay - 1] || motivationTexts[motivationTexts.length - 1];
            
            // Обновляем статистику
            updateUserStats();
            
            // Загружаем сообщения
            loadUserMessages();
            
            // Загружаем историю
            loadUserHistory();
        }

        // Обновить счетчик сообщений
        function updateInboxBadge() {
            const badge = document.getElementById('inbox-badge');
            const unreadCount = devDB.inbox.length;
            
            if (unreadCount > 0) {
                badge.classList.remove('hidden');
                badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
            } else {
                badge.classList.add('hidden');
            }
        }

        // Загрузка панели разработчика
        function loadDevPanel() {
            document.getElementById('main-screen').classList.add('hidden');
            document.getElementById('dev-panel').classList.remove('hidden');
            
            // Загружаем список пользователей
            loadUsersList();
            
            // Обновляем счетчик сообщений
            updateInboxBadge();
        }

        // Обновить счетчик сообщений
        function updateInboxBadge() {
            const badge = document.getElementById('inbox-badge');
            const unreadCount = devDB.inbox.length;
            
            if (unreadCount > 0) {
                badge.classList.remove('hidden');
                badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
            } else {
                badge.classList.add('hidden');
            }
        }

        // Загрузка списка пользователей
        function loadUsersList() {
            const usersList = document.getElementById('users-list');
            usersList.innerHTML = '';
            
            for (const username in usersDB) {
                const user = usersDB[username];
                const userElement = document.createElement('div');
                userElement.className = 'p-3 border-b cursor-pointer hover:bg-gray-700';
                userElement.innerHTML = `
                    <div class="font-semibold">${username}</div>
                    <div class="text-sm">
                        Успешных дней: ${user.stats.successDays} | 
                        Срывов: ${user.stats.failDays} | 
                        Серия: ${user.stats.currentStreak}
                    </div>
                `;
                userElement.addEventListener('click', () => showUserData(username));
                usersList.appendChild(userElement);
            }
        }

        // Поиск пользователей
        function searchUsers() {
            const searchTerm = document.getElementById('user-search').value.toLowerCase();
            const users = document.querySelectorAll('#users-list > div');
            
            users.forEach(user => {
                const username = user.querySelector('.font-semibold').textContent.toLowerCase();
                if (username.includes(searchTerm)) {
                    user.classList.remove('hidden');
                } else {
                    user.classList.add('hidden');
                }
            });
        }

        // Показать данные пользователя (для разработчика)
        function showUserData(username) {
            const user = usersDB[username];
            const container = document.getElementById('user-data-container');
            
            document.getElementById('selected-user-info').innerHTML = `
                <div class="font-semibold">${username}</div>
                <div class="text-sm mb-2">Зарегистрирован: ${new Date(user.registrationDate || Date.now()).toLocaleDateString()}</div>
                <div class="text-sm">Последняя активность: ${user.lastActivity ? new Date(user.lastActivity).toLocaleString() : 'Нет данных'}</div>
            `;
            
            // Статистика
            document.getElementById('dev-user-stats').innerHTML = `
                <div>Успешных дней: ${user.stats.successDays}</div>
                <div>Срывов: ${user.stats.failDays}</div>
                <div>Текущая серия: ${user.stats.currentStreak}</div>
                <div>Лучшая серия: ${user.stats.longestStreak}</div>
                <div class="mt-2">
                    <div class="w-full bg-gray-300 rounded-full h-2.5 dark:bg-gray-700">
                        <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${Math.round((user.stats.successDays / (user.stats.successDays + user.stats.failDays || 1)) * 100)}%"></div>
                    </div>
                    <div class="text-xs mt-1">Успех: ${Math.round((user.stats.successDays / (user.stats.successDays + user.stats.failDays || 1)) * 100)}%</div>
                </div>
            `;
            
            // История дней с более подробной информацией
            const historyContainer = document.getElementById('dev-user-history');
            historyContainer.innerHTML = '';
            
            const days = Object.keys(user.days).sort((a, b) => b - a);
            days.forEach(day => {
                const dayData = user.days[day];
                const dayElement = document.createElement('div');
                dayElement.className = 'p-2 border-b text-sm';
                dayElement.innerHTML = `
                    <div class="font-semibold">День ${day}: <span class="${dayData.status === 'success' ? 'text-green-500' : 'text-red-500'}">${dayData.status === 'success' ? 'Успех' : 'Срыв'}</span></div>
                    <div>Энергия: ${dayData.energy}/10 | Настроение: ${dayData.mood}/10</div>
                    <div class="text-xs text-gray-400">${dayData.notes || 'Нет заметок'}</div>
                    <div class="text-xs text-gray-500 mt-1">${new Date(dayData.date).toLocaleString()}</div>
                `;
                historyContainer.appendChild(dayElement);
            });
            
            container.classList.remove('hidden');
        }

        // Отметить день как успешный
        function markDayAsSuccess() {
            document.getElementById('success-btn').classList.add('bg-green-700');
            document.getElementById('fail-btn').classList.remove('bg-red-700');
        }

        // Отметить день как срыв
        function markDayAsFail() {
            document.getElementById('fail-btn').classList.add('bg-red-700');
            document.getElementById('success-btn').classList.remove('bg-green-700');
        }

        // Сохранить день
        function saveDay() {
            const user = usersDB[currentUser];
            const energy = parseInt(document.getElementById('energy-level').value);
            const mood = parseInt(document.getElementById('mood-level').value);
            const notes = document.getElementById('daily-notes').value.trim();
            
            let status = null;
            if (document.getElementById('success-btn').classList.contains('bg-green-700')) {
                status = 'success';
            } else if (document.getElementById('fail-btn').classList.contains('bg-red-700')) {
                status = 'fail';
            }
            
            if (!status) {
                alert('Пожалуйста, отметьте, был ли сегодня успех или срыв');
                return;
            }
            
            // Сохраняем день
            user.days[currentDay] = {
                status: status,
                energy: energy,
                mood: mood,
                notes: notes,
                date: new Date().toISOString()
            };
            
            // Обновляем статистику
            if (status === 'success') {
                user.stats.successDays++;
                user.stats.currentStreak++;
                if (user.stats.currentStreak > user.stats.longestStreak) {
                    user.stats.longestStreak = user.stats.currentStreak;
                }
            } else {
                user.stats.failDays++;
                user.stats.currentStreak = 0;
            }
            
            // Добавляем в историю энергии и настроения
            user.energyHistory.push(energy);
            user.moodHistory.push(mood);
            
            // Сохраняем в локальное хранилище
            localStorage.setItem('usersDB', JSON.stringify(usersDB));
            
            // Обновляем интерфейс
            updateUserStats();
            loadUserHistory();
            
            // Переходим к следующему дню, если это не последний день
            if (currentDay < 31) {
                currentDay++;
                document.getElementById('current-day').textContent = currentDay;
                document.getElementById('motivation-text').textContent = motivationTexts[currentDay - 1] || motivationTexts[motivationTexts.length - 1];
                
                // Сбрасываем поля для нового дня
                document.getElementById('energy-level').value = 5;
                document.getElementById('mood-level').value = 5;
                document.getElementById('daily-notes').value = '';
                document.getElementById('success-btn').classList.remove('bg-green-700');
                document.getElementById('fail-btn').classList.remove('bg-red-700');
            } else {
                alert('Поздравляем! Вы завершили 31-дневный челлендж!');
            }
        }

        // Inbox functions
        function showInbox() {
            const inbox = document.getElementById('inbox-modal');
            inbox.classList.remove('hidden');
            loadInboxMessages();
        }

        function hideInbox() {
            document.getElementById('inbox-modal').classList.add('hidden');
        }

        function loadInboxMessages() {
            const container = document.getElementById('inbox-messages');
            container.innerHTML = '';
            
            if (devDB.inbox.length === 0) {
                container.innerHTML = '<div class="text-center py-4 text-gray-500">Нет новых сообщений</div>';
                return;
            }
            
            devDB.inbox.forEach((msg, index) => {
                const msgElement = document.createElement('div');
                msgElement.className = 'mb-4 p-3 rounded-lg bg-gray-700 bg-opacity-20';
                msgElement.innerHTML = `
                    <div class="font-semibold">От: ${msg.fromUsername}</div>
                    <div class="text-sm mb-2">${msg.text}</div>
                    <div class="text-xs text-gray-400">${new Date(msg.date).toLocaleString()}</div>
                    <button data-index="${index}" class="reply-btn mt-2 px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm">
                        Ответить
                    </button>
                `;
                container.appendChild(msgElement);
            });
            
            // Add reply button handlers
            document.querySelectorAll('.reply-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = this.getAttribute('data-index');
                    const msg = devDB.inbox[index];
                    document.getElementById('inbox-reply').value = `@${msg.fromUsername} `;
                });
            });
        }

        function sendReply() {
            const replyText = document.getElementById('inbox-reply').value.trim();
            if (!replyText) {
                alert('Введите текст ответа');
                return;
            }
            
            // Extract username if replying to specific message
            let username = '';
            if (replyText.startsWith('@')) {
                username = replyText.split(' ')[0].substring(1);
            }
            
            if (username && usersDB[username]) {
                usersDB[username].messages.push({
                    from: 'dev',
                    text: replyText,
                    date: new Date().toISOString()
                });
                localStorage.setItem('usersDB', JSON.stringify(usersDB));
                alert('Ответ отправлен пользователю ' + username);
            } else {
                alert('Не удалось определить пользователя для ответа');
                return;
            }
            
            document.getElementById('inbox-reply').value = '';
            hideInbox();
        }

        // Обновить статистику пользователя
        function updateUserStats() {
            const user = usersDB[currentUser];
            
            // Обновляем текст статистики
            document.getElementById('user-stats').innerHTML = `
                Успешных дней: <span class="text-green-500">${user.stats.successDays}</span> |
                Срывов: <span class="text-red-500">${user.stats.failDays}</span> |
                Текущая серия: <span class="text-blue-500">${user.stats.currentStreak}</span>
            `;
            
            // Прогресс бар
            const progress = (currentDay - 1) / 31 * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;
            document.getElementById('progress-text').textContent = `${Math.round(progress)}% завершено`;
            
            // Средние значения
            if (user.energyHistory.length > 0) {
                const avgEnergy = (user.energyHistory.reduce((a, b) => a + b, 0) / user.energyHistory.length).toFixed(1);
                document.getElementById('avg-energy').textContent = avgEnergy;
            }
            
            if (user.moodHistory.length > 0) {
                const avgMood = (user.moodHistory.reduce((a, b) => a + b, 0) / user.moodHistory.length).toFixed(1);
                document.getElementById('avg-mood').textContent = avgMood;
            }
            
            // Графики
            updateCharts();
        }

        // Обновить графики
        function updateCharts() {
            const user = usersDB[currentUser];
            
            // График энергии
            const energyCtx = document.getElementById('energy-chart').getContext('2d');
            if (window.energyChart) {
                window.energyChart.destroy();
            }
            window.energyChart = new Chart(energyCtx, {
                type: 'line',
                data: {
                    labels: Array.from({length: user.energyHistory.length}, (_, i) => i + 1),
                    datasets: [{
                        label: 'Энергия',
                        data: user.energyHistory,
                        borderColor: 'rgb(59, 130, 246)',
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            min: 1,
                            max: 10
                        }
                    }
                }
            });
            
            // График настроения
            const moodCtx = document.getElementById('mood-chart').getContext('2d');
            if (window.moodChart) {
                window.moodChart.destroy();
            }
            window.moodChart = new Chart(moodCtx, {
                type: 'line',
                data: {
                    labels: Array.from({length: user.moodHistory.length}, (_, i) => i + 1),
                    datasets: [{
                        label: 'Настроение',
                        data: user.moodHistory,
                        borderColor: 'rgb(16, 185, 129)',
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            min: 1,
                            max: 10
                        }
                    }
                }
            });
        }

        // Show/hide user messages modal
        function showUserMessages() {
            document.getElementById('user-messages-modal').classList.remove('hidden');
            loadUserMessages();
        }

        function hideUserMessages() {
            document.getElementById('user-messages-modal').classList.add('hidden');
        }

        // Загрузить сообщения пользователя
        function loadUserMessages() {
            const user = usersDB[currentUser];
            const container = document.getElementById('user-messages-container');
            container.innerHTML = '';
            
            if (user.messages.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-4">Нет сообщений</div>';
                return;
            }
            
            user.messages.forEach(msg => {
                const msgElement = document.createElement('div');
                msgElement.className = 'mb-3 p-3 rounded-lg';
                if (msg.from === 'dev') {
                    msgElement.classList.add('bg-blue-900', 'bg-opacity-30');
                    msgElement.innerHTML = `
                        <div class="text-xs text-blue-400 mb-1">От разработчика</div>
                        <div>${msg.text}</div>
                        <div class="text-xs text-gray-500 mt-1">${new Date(msg.date).toLocaleString()}</div>
                    `;
                } else {
                    msgElement.classList.add('bg-gray-700', 'bg-opacity-30');
                    msgElement.innerHTML = `
                        <div class="text-xs text-gray-400 mb-1">Вы</div>
                        <div>${msg.text}</div>
                        <div class="text-xs text-gray-500 mt-1">${new Date(msg.date).toLocaleString()}</div>
                    `;
                }
                container.appendChild(msgElement);
            });
        }

        // Загрузить историю пользователя
        function loadUserHistory() {
            const user = usersDB[currentUser];
            const container = document.getElementById('history-container');
            container.innerHTML = '';
            
            const days = Object.keys(user.days).sort((a, b) => b - a);
            if (days.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-4">Нет истории</div>';
                return;
            }
            
            days.forEach(day => {
                const dayData = user.days[day];
                const dayElement = document.createElement('div');
                dayElement.className = 'mb-3 p-3 rounded-lg bg-gray-700 bg-opacity-20';
                dayElement.innerHTML = `
                    <div class="font-semibold">День ${day}: <span class="${dayData.status === 'success' ? 'text-green-500' : 'text-red-500'}">${dayData.status === 'success' ? 'Успех' : 'Срыв'}</span></div>
                    <div class="text-sm">Энергия: ${dayData.energy}/10 | Настроение: ${dayData.mood}/10</div>
                    <div class="text-xs text-gray-400 mt-1">${dayData.notes || 'Нет заметок'}</div>
                    <div class="text-xs text-gray-500 mt-1">${new Date(dayData.date).toLocaleDateString()}</div>
                `;
                container.appendChild(dayElement);
            });
        }

        // Отправить сообщение от пользователя
        function sendUserMessage() {
            const text = document.getElementById('user-message-input').value.trim();
            if (!text) {
                alert('Пожалуйста, введите текст сообщения');
                return;
            }
            
            const user = usersDB[currentUser];
            const userMessage = {
                from: 'user',
                fromUsername: currentUser,
                text: text,
                date: new Date().toISOString()
            };
            
            // Сохраняем у пользователя
            user.messages.push(userMessage);
            localStorage.setItem('usersDB', JSON.stringify(usersDB));
            
            // Отправляем разработчику
            devDB.inbox.push(userMessage);
            localStorage.setItem('devDB', JSON.stringify(devDB));
            
            document.getElementById('user-message-input').value = '';
            loadUserMessages();
            
            // Show success message
            const successMsg = document.createElement('div');
            successMsg.className = 'text-green-500 text-sm mt-2';
            successMsg.textContent = 'Сообщение отправлено';
            document.getElementById('user-messages-container').appendChild(successMsg);
            setTimeout(() => successMsg.remove(), 3000);
            
            // Обновляем бейдж, если разработчик в системе
            if (isDevMode) {
                updateInboxBadge();
            }
        }

        // Показать/скрыть inbox
        function showInbox() {
            const inbox = document.getElementById('inbox-modal');
            inbox.classList.remove('hidden');
            loadInboxMessages();
        }

        function hideInbox() {
            document.getElementById('inbox-modal').classList.add('hidden');
        }

        // Загрузить сообщения в inbox
        function loadInboxMessages() {
            const container = document.getElementById('inbox-messages');
            container.innerHTML = '';
            
            if (devDB.inbox.length === 0) {
                container.innerHTML = '<div class="text-center py-4 text-gray-500">Нет новых сообщений</div>';
                return;
            }
            
            devDB.inbox.forEach((msg, index) => {
                const msgElement = document.createElement('div');
                msgElement.className = 'mb-4 p-3 rounded-lg bg-gray-700 bg-opacity-20';
                msgElement.innerHTML = `
                    <div class="font-semibold">От: ${msg.fromUsername}</div>
                    <div class="text-sm mb-2">${msg.text}</div>
                    <div class="text-xs text-gray-400">${new Date(msg.date).toLocaleString()}</div>
                    <button data-index="${index}" class="reply-btn mt-2 px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm">
                        Ответить
                    </button>
                `;
                container.appendChild(msgElement);
            });
            
            // Add reply button handlers
            document.querySelectorAll('.reply-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = this.getAttribute('data-index');
                    const msg = devDB.inbox[index];
                    document.getElementById('inbox-reply').value = `@${msg.fromUsername} `;
                });
            });
        }

        // Отправить ответ из inbox
        function sendReply() {
            const replyText = document.getElementById('inbox-reply').value.trim();
            if (!replyText) {
                alert('Введите текст ответа');
                return;
            }
            
            // Extract username if replying to specific message
            let username = '';
            if (replyText.startsWith('@')) {
                username = replyText.split(' ')[0].substring(1);
            }
            
            if (username && usersDB[username]) {
                usersDB[username].messages.push({
                    from: 'dev',
                    text: replyText,
                    date: new Date().toISOString()
                });
                localStorage.setItem('usersDB', JSON.stringify(usersDB));
                alert('Ответ отправлен пользователю ' + username);
            } else {
                alert('Не удалось определить пользователя для ответа');
                return;
            }
            
            document.getElementById('inbox-reply').value = '';
            hideInbox();
        }

        // Отправить сообщение от разработчика
        function sendDevMessage() {
            const text = document.getElementById('dev-message').value.trim();
            const selectedUser = document.querySelector('#users-list > div:not(.hidden)');
            
            if (!selectedUser || !text) {
                alert('Пожалуйста, выберите пользователя и введите текст сообщения');
                return;
            }
            
            const username = selectedUser.querySelector('.font-semibold').textContent;
            const user = usersDB[username];
            user.messages.push({
                from: 'dev',
                text: text,
                date: new Date().toISOString()
            });
            
            localStorage.setItem('usersDB', JSON.stringify(usersDB));
            document.getElementById('dev-message').value = '';
            showUserData(username);
            
            // Если пользователь сейчас активен, обновим его сообщения
            if (currentUser === username && document.getElementById('user-panel').classList.contains('hidden') === false) {
                loadUserMessages();
            }
        }

        // Переключение темы
        function toggleTheme() {
            const themeToggle = document.getElementById('theme-toggle');
            if (document.body.classList.contains('dark-theme')) {
                document.body.classList.remove('dark-theme');
                document.body.classList.add('light-theme');
                localStorage.setItem('theme', 'light');
                themeToggle.querySelector('.fa-sun').classList.add('hidden');
                themeToggle.querySelector('.fa-moon').classList.remove('hidden');
                themeToggle.classList.remove('bg-gray-700', 'hover:bg-gray-600');
                themeToggle.classList.add('bg-gray-100', 'hover:bg-gray-200');
            } else {
                document.body.classList.remove('light-theme');
                document.body.classList.add('dark-theme');
                localStorage.setItem('theme', 'dark');
                themeToggle.querySelector('.fa-moon').classList.add('hidden');
                themeToggle.querySelector('.fa-sun').classList.remove('hidden');
                themeToggle.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                themeToggle.classList.add('bg-gray-700', 'hover:bg-gray-600');
            }
        }
    </script>
</body>
</html>
